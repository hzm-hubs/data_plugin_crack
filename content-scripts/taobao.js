var taobao=function(){"use strict";var Zt=Object.defineProperty;var eo=(U,L,M)=>L in U?Zt(U,L,{enumerable:!0,configurable:!0,writable:!0,value:M}):U[L]=M;var C=(U,L,M)=>eo(U,typeof L!="symbol"?L+"":L,M);var Ze,et;function U(t){return t}const M=(et=(Ze=globalThis.browser)==null?void 0:Ze.runtime)!=null&&et.id?globalThis.browser:globalThis.chrome,Y={"sycm.taobao":{name:"生意参谋",domain:"sycm.taobao",fullDomain:"sycm.taobao.com"},"one.alimama":{name:"阿里妈妈万象台",domain:"one.alimama",fullDomain:"one.alimama.com"},taobao:{name:"淘宝",domain:"taobao",fullDomain:"taobao.com"},tmall:{name:"天猫",domain:"tmall",fullDomain:"tmall.com"},tmallhk:{name:"天猫国际",domain:"tmallhk",fullDomain:"tmall.hk"},douyin:{name:"抖音",domain:"douyin",fullDomain:"douyin.com"},xiaohongshu:{name:"小红书",domain:"xiaohongshu",fullDomain:"xiaohongshu.com"},jd:{name:"京东",domain:"jd",fullDomain:"jd.com"},tiktok:{name:"tiktok",domain:"tiktok",fullDomain:"tiktok.com"},youtube:{name:"youtube",domain:"youtube",fullDomain:"youtube.com"},other:{name:"其他",domain:"other",fullDomain:"other"}};function nt(t){console.log("getDomain",t),t||(t=window.location.href);for(let e in Y)if(t.includes(Y[e].fullDomain))return Y[e].domain;return Y.other.domain}function st(t,e="data_"){return t&&t.indexOf("https://sycm.taobao.com/cc/customer/trip")===0?t="https://sycm.taobao.com/cc/customer/trip":t&&t.indexOf("https://sycm.taobao.com/cc/customer/overview")===0?t="https://sycm.taobao.com/cc/customer/overview":t&&t.indexOf("https://one.alimama.com/index.html#!/manage/onesite")===0&&(t="https://one.alimama.com/index.html#!/manage/onesite"),e+btoa(t)}class lt{constructor(){C(this,"sleep",e=>new Promise(o=>setTimeout(o,e)));C(this,"runDelay",async(e,o)=>new Promise(s=>setTimeout(()=>{s(e())},o)));C(this,"sendMessage",e=>{M.runtime.sendMessage({action:"updateStatus",status:e})});C(this,"sendDataWithAction",(e,o)=>{M.runtime.sendMessage({action:o,data:e})});C(this,"openPopup",(e=-1)=>{M.runtime.sendMessage({action:"openPopup",windowId:e})});C(this,"openSidePanel",(e=-1)=>{M.runtime.sendMessage({action:"openSidePanel",windowId:e})});C(this,"elementHover",(e,o=!0)=>{e.dispatchEvent(new MouseEvent(o?"mouseover":"mouseout",{bubbles:!0}))});C(this,"setElementAnimation",e=>{const o="266A247A-6C68-4F89-8D11-B767B4E7A71C",s="animation_"+o.slice(0,8),n="class_"+o.slice(0,8);if(!document.head.querySelector(`style[data-id='${o}']`)){const l=document.createElement("style");l.type="text/css",l.setAttribute("data-id",o);const a=`
      @keyframes ${s}{
        to {  background-color :rgb(255, 0, 0);
              border: 1px solid blue;
              border-radius: 3px;
        }
      }
    `,r=`
      .${n} {
        animation: ${s} 0.5s ease-in-out 0s 2 alternate none;
      }
    `;l.innerHTML=a+r,document.head.appendChild(l)}return e.classList.remove(n),e.offsetHeight,e.classList.add(n),e});C(this,"waitForChildListChange",async(e,o,s=5e3)=>new Promise((n,l)=>{const a=setTimeout(()=>{r&&(r.disconnect(),console.log("等待元素更新超时: ",o,`超时时间：${s}ms`),n(!1))},s),r=new MutationObserver((c,d)=>{if(c.length>0)for(const u of c)if(u.type==="attributes")u.attributeName;else if(u.type==="childList"){clearTimeout(a),d.disconnect(),n(!0);return}else u.type});r.observe(o,{childList:!0,subtree:!0,attributes:!0,attributeOldValue:!0,characterData:!0,characterDataOldValue:!0}),e&&e()}));C(this,"waitForElementTextChange",async(e,o,s=5e3)=>new Promise((n,l)=>{console.log("等待元素更新:",o,` 超时: ${s}ms`);const a=setTimeout(()=>{r&&(r.disconnect(),console.log("等待元素更新超时: ",o,`超时时间：${s}ms`),n(!1))},s),r=new MutationObserver((c,d)=>{if(c.length>0){for(const u of c)if(u.type==="attributes")u.attributeName;else if(u.type!=="childList"){if(u.type==="characterData"){clearTimeout(a),d.disconnect(),n(!0);return}}}});r.observe(o,{childList:!0,subtree:!0,attributes:!0,attributeOldValue:!0,characterData:!0,characterDataOldValue:!0}),e&&e()}));C(this,"waitForElementAttrChange",async(e,o,s=5e3)=>new Promise((n,l)=>{console.log("等待元素属性更新:",o,` 超时: ${s}ms`);const a=setTimeout(()=>{r&&(r.disconnect(),console.log("等待元素属性更新超时: ",o,`超时时间：${s}ms`),n(!1))},s),r=new MutationObserver((c,d)=>{if(c.length>0)for(const u of c)if(u.type==="attributes"){u.attributeName,clearTimeout(a),d.disconnect(),n(!0);return}else u.type==="childList"||u.type});r.observe(o,{childList:!0,subtree:!0,attributes:!0,attributeOldValue:!0,characterData:!0,characterDataOldValue:!0}),e&&e()}));C(this,"waitForElementListTextChange",async(e,o,s=5e3,n=!0)=>{let l=[];return new Promise((a,r)=>{o.forEach(c=>{this.waitForElementTextChange(()=>{},c,s).then(async d=>{l.push({target:c,result:d}),n?l.length===o.length&&a(l):l.length==1&&(await this.sleep(500),a(l))})}),e&&e()})});C(this,"waitForElementListAttrChange",async(e,o,s=5e3,n=!0)=>{let l=[];return new Promise((a,r)=>{o.forEach(c=>{this.waitForElementAttrChange(()=>{},c,s).then(async d=>{l.push({target:c,result:d}),n?l.length===o.length&&a(l):l.length==1&&(await this.sleep(500),a(l))})}),e&&e()})});C(this,"waitForElementRemove",async(e,o=5e3)=>new Promise((s,n)=>{const a=o/10;let r=0;const c=setInterval(()=>{if(!document.querySelector(e)){clearInterval(c),s(!0);return}r++,r<a?console.log("等待元素移除:",e,` 超时: ${o}ms`,`剩余时间：${o-r*10}ms`):(console.log("等待元素移除超时: ",e,`超时时间：${o}ms`),clearInterval(c),n(!1))},10)}));C(this,"scrollToElementTop",e=>{e.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})});C(this,"scrollToElement",e=>{e.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})});C(this,"scrollToElementBottom",e=>{e.scrollIntoView({behavior:"smooth",block:"end",inline:"nearest"})});C(this,"ensureElementVisible",e=>{let o=e;for(;o&&o!==document.body;){const r=o.parentElement;if(!r)break;const c=r.scrollHeight>r.clientHeight,d=r.scrollWidth>r.clientWidth;if(c||d){const u=r.getBoundingClientRect(),i=o.getBoundingClientRect();c&&(i.top<u.top?r.scrollTop-=u.top-i.top:i.bottom>u.bottom&&(r.scrollTop+=i.bottom-u.bottom)),d&&(i.left<u.left?r.scrollLeft-=u.left-i.left:i.right>u.right&&(r.scrollLeft+=i.right-u.right))}o=r}const s=window.scrollY,n=s+window.innerHeight,l=e.offsetTop,a=l+e.offsetHeight;l<s?window.scrollTo({top:l,behavior:"smooth"}):a>n&&window.scrollTo({top:a-window.innerHeight,behavior:"smooth"})});C(this,"getTextNodeValue",(e,o=!1)=>{this.setElementAnimation(e);const s=Array.from(e.childNodes).filter(n=>n.nodeType===Node.TEXT_NODE).map(n=>n.textContent).join("");return o?+s.replace(/[^\d-.]/g,""):s});C(this,"getElementText",(e,o=!0)=>e?(o&&this.setElementAnimation(e),e.textContent):"");C(this,"getElementTextToNumber",(e,o=!0)=>{if(e){const s=this.getElementText(e,o).replace(/[^\d-.]/g,"");return s&&!isNaN(s)?+s:s}return 0});C(this,"getUserInputNumber",async(e=10,o="请输入最大数据条数，默认10条，最小1条，最大100条",s=100)=>{let n=await this.showInput(o,e,s);for(;n;){let l=0;if(!isNaN(n)&&(l=parseInt(n),l>0&&l<=s)){e=l;break}n=await this.showInput(o,e,s)}return e});C(this,"waitElementInViewportUseObserver",async(e,o=5e3)=>new Promise((s,n)=>{this.isElementInViewport(e)&&s(!0),setTimeout(()=>{s(!1),l.disconnect()},o);const l=new IntersectionObserver(a=>{a.forEach(async r=>{r.isIntersecting&&(s(!0),l.disconnect())})});if(!e)return n("元素不存在");this.scrollToElement(e),l.observe(e)}));C(this,"waitElementInViewportUseClientRect",async(e,o=!1,s=5e3)=>{new Promise(async(n,l)=>{if(!e||typeof e.getBoundingClientRect!="function")return n(!1);let a=null;const r=()=>{const i=e.getBoundingClientRect(),h=window.innerHeight||document.documentElement.clientHeight,v=window.innerWidth||document.documentElement.clientWidth;let b=!1;if(o)b=i.top>=0&&i.bottom<=h&&i.left>=0&&i.right<=v;else{const y=i.top<=h&&i.bottom>=0,w=i.left<=v&&i.right>=0;b=y&&w}b&&(a&&clearInterval(a),n(!0))},c=10,d=parseInt(s/c+"")>0?parseInt(s/c+""):1;let u=0;a=setInterval(()=>{u++,u>d?(a&&clearInterval(a),n(!1)):r()},c)})});C(this,"isElementInViewport",e=>{const o=e.getBoundingClientRect(),s=window.innerHeight||document.documentElement.clientHeight,n=window.innerWidth||document.documentElement.clientWidth;return o.top<s&&o.bottom>0&&o.left<n&&o.right>0});C(this,"getItemTextAndLog",(e,o,s,n="")=>{const l=this.querySelector(e,o);let a=this.getElementText(l);return n&&(a=(l==null?void 0:l.getAttribute(n))||""),s&&!l&&console.log(s),a});C(this,"waitForResult",async(e,o=5e3)=>{const s=Math.floor(o/100);for(let n=0;n<s;n++){if(await e())return!0;await this.sleep(100)}return!1});C(this,"getNumberText",e=>{const o=e.match(/[\.\d]+(千万)?(万亿)?[万|亿|k|K|m|M|b|B]?/);return o?o[0]:e})}deepScroll(e){return new Promise((o,s)=>{const n=[],l={element:e.element||window,duration:e.duration||500,easing:e.easing||"easeInOutQuad",scrollContainers:n,left:e.left,top:e.top,target:e.target,callback:e.callback};function a(m){const p=[];let f=m;for(;f&&f!==document.documentElement;)r(f)&&p.push(f),f=f.parentElement;return c()&&p.push(window),p}function r(m){if(m===window||!(m instanceof HTMLElement))return!0;const p=getComputedStyle(m),f=p.overflowY==="auto"||p.overflowY==="scroll",$=p.overflowX==="auto"||p.overflowX==="scroll";return f&&m.scrollHeight>m.clientHeight||$&&m.scrollWidth>m.clientWidth}function c(){return document.documentElement.scrollHeight>window.innerHeight}function d(m,p){const f=p.getBoundingClientRect();if(m instanceof Window)return{top:u(f.top-window.pageYOffset+window.outerHeight,f.height,window.innerHeight,window.outerHeight),left:u(f.left-window.pageXOffset+window.outerWidth,f.width,window.innerWidth,window.outerWidth)};const $=m.getBoundingClientRect();return{top:u(f.top-$.top+m.scrollTop,f.height,m.clientHeight,m.scrollTop),left:u(f.left-$.left+m.scrollLeft,f.width,m.clientWidth,m.scrollLeft)}}function u(m,p,f,$){const I=$,q=$+f,K=m+p;return m>=I&&K<=q?$:m<I?m:K-f}function i(m){return m instanceof Window?window.pageYOffset:m.scrollTop}function h(m){return m instanceof Window?window.pageXOffset:m.scrollLeft}function v(m,p,f){m instanceof Window?window.scrollTo(f,p):(m.scrollTop=p,m.scrollLeft=f)}if(l.target){const m=a(l.target);let p=l.target;m.forEach(f=>{const $=d(f,p);l.scrollContainers.push({element:f,startTop:i(f),targetTop:$.top,startLeft:h(f),targetLeft:$.left}),p=f})}else l.scrollContainers.push({element:l.element,startTop:i(l.element),targetTop:l.top??i(l.element),startLeft:h(l.element),targetLeft:l.left??h(l.element)});const b={linear:m=>m,easeInQuad:m=>m*m,easeOutQuad:m=>m*(2-m),easeInOutQuad:m=>m<.5?2*m*m:-1+(4-2*m)*m},y=b[l.easing]||b.easeInOutQuad;let w=0;const x=()=>{var m;o(""),l.target,(m=l.callback)==null||m.call(l)},g=m=>{w||(w=m);const p=m-w,f=Math.min(p/l.duration,1),$=y(f);l.scrollContainers.forEach(({element:I,startTop:q,targetTop:K,startLeft:oe,targetLeft:ge})=>{const ne=q+(K-q)*$,pe=oe+(ge-oe)*$;v(I,ne,pe)}),p<l.duration?requestAnimationFrame(g):x()};requestAnimationFrame(g)})}async showInput(e,o,s){return new Promise((n,l)=>{M.runtime.sendMessage({action:"showInput",placeholder:e,defaultValue:o,max:s},a=>{n(a.value)})})}simpleUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const o=Math.random()*16|0;return(e==="x"?o:o&3|8).toString(16)})}formatDateTime(e,o=!1){if(typeof e=="string")e=new Date(e);else if(typeof e=="number")e=new Date(e);else if(!(e instanceof Date))return"";if(isNaN(e))return"";const s={year:e.getFullYear(),mounth:e.getMonth()+1,day:e.getDate(),hour:e.getHours(),minute:e.getMinutes(),second:e.getSeconds(),ms:e.getMilliseconds()},n=(a,r=2)=>(a+"").padStart(r,"0");let l=`${s.year}-${n(s.mounth)}-${n(s.day)} ${n(s.hour)}:${n(s.minute)}:${n(s.second)}`;return o&&(l+=`:${s.ms}`),l}formatDate(e){const o=this.formatDateTime(e);return o?o.split(" ")[0]:""}parseChineseNumber(e){const o={万亿:1e12,千亿:1e11,百亿:1e10,十亿:1e9,亿:1e8,千万:1e7,百万:1e6,万:1e4,千:1e3,百:100,十:10,k:1e3,K:1e3,m:1e6,M:1e6,b:1e9,B:1e9,t:1e12,T:1e12};let s="";for(const d in o)s?s+="|"+d:s+=d;const n=String(e).match(new RegExp(`^(\\d+.?\\d*)([${s})]*)`));if(!n)return 0;const l=parseFloat(n[1]),a=n[2].trim(),r=Object.keys(o).find(d=>a.startsWith(d)),c=r?o[r]:1;return a==="千万"?l*1e7:l*c}querySelector(e,o=[]){let s=null;for(const n of o){const l=n.match(/(.+):contains\(['"](.+)['"]\)/);if(l){const a=l[1],r=l[2];if(s=e.querySelector(a),s&&s.textContent.includes(r))break}else if(s=e.querySelector(n),s)break}return s}querySelectorAll(e,o=[]){for(const s of o){const n=s.match(/(.+):contains\(['"](.+)['"]\)/);if(n){const l=n[1],a=n[2],r=e.querySelectorAll(l);if(r&&r.length>0)return Array.from(r).filter(d=>d.textContent.includes(a))}else{const l=e.querySelectorAll(s);if(l.length>0)return Array.from(l)}}return[]}querySelectorWithText(e,o=[],s=""){let n=null;for(const l of o)if(n=e.querySelectorAll(l),n.length>0){for(const a of n)if(a.textContent.includes(s))return a}return null}querySelectorAllWithText(e,o=[],s=""){let n=null;for(const l of o)if(n=e.querySelectorAll(l),n.length>0)return Array.from(n).filter(a=>a.textContent.includes(s));return[]}}const E=new lt;function rt(t){M.runtime.onMessage.addListener((e,o,s)=>{if(e.action==="getData")return console.log("收到获取数据请求"),(async()=>{try{const n=await ct(t);M.runtime.sendMessage({action:"dataReceived",data:n}),s({data:n})}catch(n){console.error("抓取数据时出错:",n),M.runtime.sendMessage({action:"dataError",error:n.message})}})(),s({action:"__default"}),!0})}async function ct(t){const e=window.location.href,o=st(e),s=nt(e);try{const n=await t(s,e);return console.log(`抓取到${s}数据:`,n),n.type=="unsupported"&&E.sendMessage("前页面不支持数据抓取"),await M.storage.local.set({[o]:{domain:s,type:n.type,data:n.data,timestamp:new Date().getTime(),fetchTime:n.fetchTime,url:e}}),n}catch(n){throw console.error("抓取过程中发生错误:",n),n}}async function at(){console.log("准备抓取淘宝搜索页数据..."),await it(),await new Promise(s=>setTimeout(s,1e3));const t=document.querySelector(".content--CUnfXXxv");if(!t)return console.error("找不到商品列表容器"),{searchList:[]};const e=t.querySelectorAll("div.tbpc-col.search-content-col"),o=[];return e.forEach(s=>{const n=s.querySelector(".title--qJ7Xg_90 span"),l=n?n.innerText.trim():"",a=s.querySelector(".priceInt--yqqZMJ5a"),r=s.querySelector(".priceFloat--XpixvyQ1"),c=a?a.innerText.trim()+(r?r.innerText.trim():""):"",d=s.querySelector(".mainPicAdaptWrapper--V_ayd2hD img"),u=d?d.src:"",i=s.querySelector("a");let h="";i&&(h=i.href,h.startsWith("//")&&(h="https:"+h));const v=s.querySelector(".realSales--XZJiepmt"),b=v?v.innerText.trim():"";(l||c)&&o.push({title:l,price:c,image:u,link:h,sales:b})}),console.log("抓取到搜索页数据:",o.length,"条"),E.sendMessage(`抓取到搜索页数据 ${o.length} 条`),{searchList:o}}async function it(){console.log("开始滚动淘宝搜索页面以加载所有商品..."),E.sendMessage("正在加载搜索结果，请稍候...");try{const t=Math.max(document.body.scrollHeight,document.documentElement.scrollHeight),e=t/15;let o=0;console.log("开始滚动，页面总高度:",t,"px");for(let s=0;s<15;s++)window.scrollTo({top:o,behavior:"smooth"}),o+=e,s%3===0&&console.log("滚动中...",Math.min(o,t),"/",t,"px"),await new Promise(n=>setTimeout(n,200));return console.log("滚动到底部完成，等待内容加载..."),await new Promise(s=>setTimeout(s,1e3)),console.log("滚动回顶部..."),window.scrollTo({top:0,behavior:"smooth"}),await new Promise(s=>setTimeout(s,500)),console.log("完成滚动和等待，页面应已完全加载"),E.sendMessage("页面加载完成，开始抓取数据..."),!0}catch(t){return console.error("滚动过程中出错:",t),!1}}async function ut(){const t=[],e=new Set,o=['[class*="skuItem--"]:not([class*="serviceCateItem--"])',".tb-prop:not(.tb-service)",".tm-sale-prop:not(.tm-service)",".J_TSaleProp:not(.service)"];for(const s of o){const n=document.querySelectorAll(s);if(!(!n||n.length===0))for(const l of n){if(l.className.includes("Operation--")||l.className.includes("Service--")||l.className.includes("BuyPattern--"))continue;const a=l.querySelector('[class*="ItemLabel--"], [class*="labelText--"], .tb-label, .tm-label, .sku-label, .prop-name');if(!a)continue;const r=a.textContent.trim();if(r==="数量"||r==="特色服务"||r==="保障服务"||e.has(r))continue;const c=l.querySelector('[class*="content--"], .tb-sku-list, .J_TSaleProp ul, .sku-options, .prop-values');if(!c)continue;const d=c.querySelectorAll('[class*="valueItem--"], .tb-selected, .tb-sku-item, .J_TSaleProp li, .sku-option, .prop-value');if(!d||d.length===0)continue;const u=[],i=new Set;for(const h of d){if(h.className.includes("countWrapper--")||h.className.includes("quantityBtn--"))continue;const b=(h.querySelector('[class*="valueItemText--"], span, a')||h).innerText.trim();if(i.has(b))continue;const y=h.querySelector('[class*="valueItemImg--"], img'),w=y?y.src:"",x=h.className.includes("isDisabled--")||h.className.includes("tb-out-of-stock")||h.className.includes("disabled");u.push({text:b,imgUrl:w,hasStock:!x}),i.add(b)}u.length>0&&(t.push({typeName:r,options:u}),e.add(r))}}return t}/**
* @vue/shared v3.5.18
* (c) 2018-present Yuxi (Evan) You and Vue contributors
* @license MIT
**//*! #__NO_SIDE_EFFECTS__ */function mt(t){const e=Object.create(null);for(const o of t.split(","))e[o]=1;return o=>o in e}const dt=Object.assign,ft=Object.prototype.hasOwnProperty,ye=(t,e)=>ft.call(t,e),z=Array.isArray,le=t=>je(t)==="[object Map]",ht=t=>typeof t=="string",J=t=>typeof t=="symbol",re=t=>t!==null&&typeof t=="object",gt=Object.prototype.toString,je=t=>gt.call(t),pt=t=>je(t).slice(8,-1),Se=t=>ht(t)&&t!=="NaN"&&t[0]!=="-"&&""+parseInt(t,10)===t,ce=(t,e)=>!Object.is(t,e);/**
* @vue/reactivity v3.5.18
* (c) 2018-present Yuxi (Evan) You and Vue contributors
* @license MIT
**/let wt,He=0,xe;function $e(){He++}function Te(){if(--He>0)return;let t;for(;xe;){let e=xe;for(xe=void 0;e;){const o=e.next;if(e.next=void 0,e.flags&=-9,e.flags&1)try{e.trigger()}catch(s){t||(t=s)}e=o}}if(t)throw t}let ae=!0;const We=[];function bt(){We.push(ae),ae=!1}function vt(){const t=We.pop();ae=t===void 0?!0:t}class yt{constructor(e){this.computed=e,this.version=0,this.activeLink=void 0,this.subs=void 0,this.map=void 0,this.key=void 0,this.sc=0,this.__v_skip=!0}track(e){}trigger(e){this.version++,this.notify(e)}notify(e){$e();try{for(let o=this.subs;o;o=o.prevSub)o.sub.notify()&&o.sub.dep.notify()}finally{Te()}}}const Ce=new WeakMap,F=Symbol(""),Ee=Symbol(""),Q=Symbol("");function A(t,e,o){if(ae&&wt){let s=Ce.get(t);s||Ce.set(t,s=new Map);let n=s.get(o);n||(s.set(o,n=new yt),n.map=s,n.key=o),n.track()}}function j(t,e,o,s,n,l){const a=Ce.get(t);if(!a)return;const r=c=>{c&&c.trigger()};if($e(),e==="clear")a.forEach(r);else{const c=z(t),d=c&&Se(o);if(c&&o==="length"){const u=Number(s);a.forEach((i,h)=>{(h==="length"||h===Q||!J(h)&&h>=u)&&r(i)})}else switch((o!==void 0||a.has(void 0))&&r(a.get(o)),d&&r(a.get(Q)),e){case"add":c?d&&r(a.get("length")):(r(a.get(F)),le(t)&&r(a.get(Ee)));break;case"delete":c||(r(a.get(F)),le(t)&&r(a.get(Ee)));break;case"set":le(t)&&r(a.get(F));break}}Te()}function X(t){const e=_(t);return e===t?e:(A(e,"iterate",Q),B(t)?e:e.map(R))}function Ie(t){return A(t=_(t),"iterate",Q),t}const St={__proto__:null,[Symbol.iterator](){return _e(this,Symbol.iterator,R)},concat(...t){return X(this).concat(...t.map(e=>z(e)?X(e):e))},entries(){return _e(this,"entries",t=>(t[1]=R(t[1]),t))},every(t,e){return V(this,"every",t,e,void 0,arguments)},filter(t,e){return V(this,"filter",t,e,o=>o.map(R),arguments)},find(t,e){return V(this,"find",t,e,R,arguments)},findIndex(t,e){return V(this,"findIndex",t,e,void 0,arguments)},findLast(t,e){return V(this,"findLast",t,e,R,arguments)},findLastIndex(t,e){return V(this,"findLastIndex",t,e,void 0,arguments)},forEach(t,e){return V(this,"forEach",t,e,void 0,arguments)},includes(...t){return De(this,"includes",t)},indexOf(...t){return De(this,"indexOf",t)},join(t){return X(this).join(t)},lastIndexOf(...t){return De(this,"lastIndexOf",t)},map(t,e){return V(this,"map",t,e,void 0,arguments)},pop(){return G(this,"pop")},push(...t){return G(this,"push",t)},reduce(t,...e){return Fe(this,"reduce",t,e)},reduceRight(t,...e){return Fe(this,"reduceRight",t,e)},shift(){return G(this,"shift")},some(t,e){return V(this,"some",t,e,void 0,arguments)},splice(...t){return G(this,"splice",t)},toReversed(){return X(this).toReversed()},toSorted(t){return X(this).toSorted(t)},toSpliced(...t){return X(this).toSpliced(...t)},unshift(...t){return G(this,"unshift",t)},values(){return _e(this,"values",R)}};function _e(t,e,o){const s=Ie(t),n=s[e]();return s!==t&&!B(t)&&(n._next=n.next,n.next=()=>{const l=n._next();return l.value&&(l.value=o(l.value)),l}),n}const xt=Array.prototype;function V(t,e,o,s,n,l){const a=Ie(t),r=a!==t&&!B(t),c=a[e];if(c!==xt[e]){const i=c.apply(t,l);return r?R(i):i}let d=o;a!==t&&(r?d=function(i,h){return o.call(this,R(i),h,t)}:o.length>2&&(d=function(i,h){return o.call(this,i,h,t)}));const u=c.call(a,d,s);return r&&n?n(u):u}function Fe(t,e,o,s){const n=Ie(t);let l=o;return n!==t&&(B(t)?o.length>3&&(l=function(a,r,c){return o.call(this,a,r,c,t)}):l=function(a,r,c){return o.call(this,a,R(r),c,t)}),n[e](l,...s)}function De(t,e,o){const s=_(t);A(s,"iterate",Q);const n=s[e](...o);return(n===-1||n===!1)&&Ot(o[0])?(o[0]=_(o[0]),s[e](...o)):n}function G(t,e,o=[]){bt(),$e();const s=_(t)[e].apply(t,o);return Te(),vt(),s}const $t=mt("__proto__,__v_isRef,__isVue"),Be=new Set(Object.getOwnPropertyNames(Symbol).filter(t=>t!=="arguments"&&t!=="caller").map(t=>Symbol[t]).filter(J));function Tt(t){J(t)||(t=String(t));const e=_(this);return A(e,"has",t),e.hasOwnProperty(t)}class Ke{constructor(e=!1,o=!1){this._isReadonly=e,this._isShallow=o}get(e,o,s){if(o==="__v_skip")return e.__v_skip;const n=this._isReadonly,l=this._isShallow;if(o==="__v_isReactive")return!n;if(o==="__v_isReadonly")return n;if(o==="__v_isShallow")return l;if(o==="__v_raw")return s===(n?l?Nt:ze:l?Pt:Ye).get(e)||Object.getPrototypeOf(e)===Object.getPrototypeOf(s)?e:void 0;const a=z(e);if(!n){let c;if(a&&(c=St[o]))return c;if(o==="hasOwnProperty")return Tt}const r=Reflect.get(e,o,ee(e)?e:s);return(J(o)?Be.has(o):$t(o))||(n||A(e,"get",o),l)?r:ee(r)?a&&Se(o)?r:r.value:re(r)?n?Xe(r):qe(r):r}}class Ct extends Ke{constructor(e=!1){super(!1,e)}set(e,o,s,n){let l=e[o];if(!this._isShallow){const c=Z(l);if(!B(s)&&!Z(s)&&(l=_(l),s=_(s)),!z(e)&&ee(l)&&!ee(s))return c?!1:(l.value=s,!0)}const a=z(e)&&Se(o)?Number(o)<e.length:ye(e,o),r=Reflect.set(e,o,s,ee(e)?e:n);return e===_(n)&&(a?ce(s,l)&&j(e,"set",o,s):j(e,"add",o,s)),r}deleteProperty(e,o){const s=ye(e,o);e[o];const n=Reflect.deleteProperty(e,o);return n&&s&&j(e,"delete",o,void 0),n}has(e,o){const s=Reflect.has(e,o);return(!J(o)||!Be.has(o))&&A(e,"has",o),s}ownKeys(e){return A(e,"iterate",z(e)?"length":F),Reflect.ownKeys(e)}}class Et extends Ke{constructor(e=!1){super(!0,e)}set(e,o){return!0}deleteProperty(e,o){return!0}}const It=new Ct,_t=new Et,Me=t=>t,ie=t=>Reflect.getPrototypeOf(t);function Dt(t,e,o){return function(...s){const n=this.__v_raw,l=_(n),a=le(l),r=t==="entries"||t===Symbol.iterator&&a,c=t==="keys"&&a,d=n[t](...s),u=o?Me:e?Ae:R;return!e&&A(l,"iterate",c?Ee:F),{next(){const{value:i,done:h}=d.next();return h?{value:i,done:h}:{value:r?[u(i[0]),u(i[1])]:u(i),done:h}},[Symbol.iterator](){return this}}}}function ue(t){return function(...e){return t==="delete"?!1:t==="clear"?void 0:this}}function Mt(t,e){const o={get(n){const l=this.__v_raw,a=_(l),r=_(n);t||(ce(n,r)&&A(a,"get",n),A(a,"get",r));const{has:c}=ie(a),d=e?Me:t?Ae:R;if(c.call(a,n))return d(l.get(n));if(c.call(a,r))return d(l.get(r));l!==a&&l.get(n)},get size(){const n=this.__v_raw;return!t&&A(_(n),"iterate",F),Reflect.get(n,"size",n)},has(n){const l=this.__v_raw,a=_(l),r=_(n);return t||(ce(n,r)&&A(a,"has",n),A(a,"has",r)),n===r?l.has(n):l.has(n)||l.has(r)},forEach(n,l){const a=this,r=a.__v_raw,c=_(r),d=e?Me:t?Ae:R;return!t&&A(c,"iterate",F),r.forEach((u,i)=>n.call(l,d(u),d(i),a))}};return dt(o,t?{add:ue("add"),set:ue("set"),delete:ue("delete"),clear:ue("clear")}:{add(n){!e&&!B(n)&&!Z(n)&&(n=_(n));const l=_(this);return ie(l).has.call(l,n)||(l.add(n),j(l,"add",n,n)),this},set(n,l){!e&&!B(l)&&!Z(l)&&(l=_(l));const a=_(this),{has:r,get:c}=ie(a);let d=r.call(a,n);d||(n=_(n),d=r.call(a,n));const u=c.call(a,n);return a.set(n,l),d?ce(l,u)&&j(a,"set",n,l):j(a,"add",n,l),this},delete(n){const l=_(this),{has:a,get:r}=ie(l);let c=a.call(l,n);c||(n=_(n),c=a.call(l,n)),r&&r.call(l,n);const d=l.delete(n);return c&&j(l,"delete",n,void 0),d},clear(){const n=_(this),l=n.size!==0,a=n.clear();return l&&j(n,"clear",void 0,void 0),a}}),["keys","values","entries",Symbol.iterator].forEach(n=>{o[n]=Dt(n,t,e)}),o}function Ue(t,e){const o=Mt(t,e);return(s,n,l)=>n==="__v_isReactive"?!t:n==="__v_isReadonly"?t:n==="__v_raw"?s:Reflect.get(ye(o,n)&&n in s?o:s,n,l)}const qt={get:Ue(!1,!1)},At={get:Ue(!0,!1)},Ye=new WeakMap,Pt=new WeakMap,ze=new WeakMap,Nt=new WeakMap;function kt(t){switch(t){case"Object":case"Array":return 1;case"Map":case"Set":case"WeakMap":case"WeakSet":return 2;default:return 0}}function Rt(t){return t.__v_skip||!Object.isExtensible(t)?0:kt(pt(t))}function qe(t){return Z(t)?t:Je(t,!1,It,qt,Ye)}function Xe(t){return Je(t,!0,_t,At,ze)}function Je(t,e,o,s,n){if(!re(t)||t.__v_raw&&!(e&&t.__v_isReactive))return t;const l=Rt(t);if(l===0)return t;const a=n.get(t);if(a)return a;const r=new Proxy(t,l===2?s:o);return n.set(t,r),r}function Z(t){return!!(t&&t.__v_isReadonly)}function B(t){return!!(t&&t.__v_isShallow)}function Ot(t){return t?!!t.__v_raw:!1}function _(t){const e=t&&t.__v_raw;return e?_(e):t}const R=t=>re(t)?qe(t):t,Ae=t=>re(t)?Xe(t):t;function ee(t){return t?t.__v_isRef===!0:!1}/*!
 * pinia v3.0.3
 * (c) 2025 Eduardo San Martin Morote
 * @license MIT
 */var Qe;(function(t){t.direct="direct",t.patchObject="patch object",t.patchFunction="patch function"})(Qe||(Qe={}));const Pe=()=>({feishu:{label:"飞书多维表格设置",feishu_base_url:{value:"",max:200,defalutVaue:"",label:"多维表格URL",placeholder:"多维表格URL 例如: https://mideqnf1p7d.feishu.cn/base/TAAsbKNniaMaodss84tcEQSun3f?table=tbllpvh8BykaNQBM&view=vewvd05oOX"}},dignding:{label:"钉钉AI表格设置",appKey:{value:"",max:100,defalutVaue:"",label:"appKey",placeholder:"appKey"},appSecret:{value:"",max:100,defalutVaue:"",label:"appSecret",placeholder:"appSecret"},baseId:{value:"",max:100,defalutVaue:"",label:"baseId",placeholder:"baseId 文档Id"},phone:{value:"",max:100,defalutVaue:"",label:"手机号",placeholder:"钉钉用户绑定的手机号码"}},douyin:{label:"抖音设置",maxSearchListCount:{value:100,max:200,defalutVaue:100,label:"搜索列表数量",placeholder:"搜索列表数量"},maxUserVideoCount:{value:100,max:200,defalutVaue:100,label:"最大用户视频数量",placeholder:"最大用户视频数量"},maxCommentsCount:{value:100,max:200,defalutVaue:100,label:"最大评论数量",placeholder:"最大评论数量"}},xiaohongshu:{label:"小红书设置",maxSearchListCount:{value:100,max:200,defalutVaue:100,label:"搜索列表数量",placeholder:"搜索列表数量"},maxUserNoteCount:{value:100,max:200,defalutVaue:100,label:"最大用户笔记数量",placeholder:"最大用户笔记数量"},maxCommentsCount:{value:100,max:200,defalutVaue:100,label:"最大评论数量",placeholder:"最大评论数量"}},jd:{label:"京东设置",maxSearchListCount:{value:100,max:200,defalutVaue:100,label:"搜索列表数量",placeholder:"搜索列表数量"},maxCommentsCount:{value:100,max:200,defalutVaue:100,label:"最大评论数量",placeholder:"最大评论数量"}},taobao:{label:"淘宝设置",maxCommentsCount:{value:100,max:200,defalutVaue:100,label:"最大评论数量",placeholder:"最大评论数量"}},sycm_taobao:{label:"生意参谋设置",maxOverviewDataCount:{value:100,max:200,defalutVaue:100,label:"最大客户概况数量",placeholder:"最大客户概况数量"},maxCustomerTripDataCount:{value:100,max:200,defalutVaue:100,label:"最大客户旅程数量",placeholder:"最大客户旅程数量"},maxCustomerTripGoodsDataCount:{value:100,max:200,defalutVaue:100,label:"最大客户旅程商品数量",placeholder:"最大客户旅程商品数量"}},one_alimama:{label:"阿里妈妈万象台设置",maxGoodsListCount:{value:100,max:200,defalutVaue:100,label:"最大商品数量",placeholder:"最大商品数量"}},tiktok:{label:"tiktok设置",maxSearchListCount:{value:100,max:200,defalutVaue:100,label:"搜索列表数量",placeholder:"搜索列表数量"},maxUserVideoCount:{value:100,max:200,defalutVaue:100,label:"最大用户视频数量",placeholder:"最大用户视频数量"},maxCommentsCount:{value:100,max:200,defalutVaue:100,label:"最大评论数量",placeholder:"最大评论数量"}},youtube:{label:"tiktok设置",maxSearchListCount:{value:100,max:200,defalutVaue:100,label:"搜索列表数量",placeholder:"搜索列表数量"},maxUserVideoCount:{value:100,max:200,defalutVaue:100,label:"最大用户视频数量",placeholder:"最大用户视频数量"},maxCommentsCount:{value:100,max:200,defalutVaue:100,label:"最大评论数量",placeholder:"最大评论数量"}}});let Vt=Pe();qe(Vt);const Ge="__setting",Lt=async()=>{var e=(await M.storage.local.get([Ge]))[Ge];if(e){const s=e;var o=Pe();return Object.keys(o).forEach(n=>{n in s||(s[n]=o[n])}),s}else return Pe()};async function jt(){console.log("开始抓取评论"),E.sendMessage("正在抓取评论...");const e=(await Lt()).taobao.maxCommentsCount.value,o=e;try{let s=function(y){console.log(`解析评论数量文本: "${y}"`),y=y.replace(/\s+/g,"");let w=y.match(/全部\(([^)]+)\)/);if(w){const g=w[1];if(console.log(`提取括号内容: "${g}"`),g.includes("万"))return console.log(`检测到"万"字，评论数量肯定超过100，使用最大值 ${o}`),o;const m=parseInt(g,10);if(!isNaN(m))return console.log(`解析为数字: ${m}`),m>=100?(console.log(`评论数量 ${m} >= 100，使用最大值 ${o}`),o):m;if(g.includes("+"))return console.log(`检测到"+"号，评论数量可能很大，使用最大值 ${o}`),o}const x=parseInt(y,10);return isNaN(x)?(console.log(`无法解析评论数量，使用默认最大值: ${o}`),o):(console.log(`直接解析为数字: ${x}`),x>=100?(console.log(`评论数量 ${x} >= 100，使用最大值 ${o}`),o):x)},n=function(y,w){const x=document.querySelectorAll(y);return Array.from(x).filter(g=>g.textContent.includes(w))};console.log("初始HTML状态:",document.body.innerHTML.substring(0,500)+"..."),console.log("尝试获取评论总数");let l=e;const a=['span[class*="tagItem"][class*="isSelected"]','span:contains("全部(")',".rate-counter",".comment-count",".review-count"];for(const y of a)try{if(y.includes(":contains(")){const w=document.querySelectorAll("span");for(const x of w)if(x.textContent.includes("全部(")){console.log(`找到可能包含评论数的元素: "${x.textContent}"`);const g=s(x.textContent);if(g!==null){l=g,console.log(`成功解析评论总数: ${l}`);break}}}else{const w=document.querySelector(y);if(w){console.log(`找到可能包含评论数的元素: "${w.textContent}"`);const x=s(w.textContent);if(x!==null){l=x,console.log(`成功解析评论总数: ${l} (从 ${y})`);break}}}}catch(w){console.error(`选择器 ${y} 出错:`,w)}isNaN(l)||l<=0?(l=o,console.log(`未找到有效的评论总数，使用默认值: ${o}`)):console.log(`使用实际评论总数: ${l}`);const r=Math.min(l,o);console.log(`期望获取的评论数量: ${r}`),console.log("尝试滚动到参数信息");const c=["p.tabDetailItemTitle--RW7pKjfx",'p[class*="tabDetailItemTitle"]','p[data-spm-anchor-id*="pc_detail.29232929.202205"]','p:contains("参数信息")'];let d=null;for(const y of c)try{if(y.includes(":contains(")){const w=document.querySelectorAll("p");for(const x of w)if(x.textContent.includes("参数信息")){d=x,console.log("找到参数信息元素:",x.textContent);break}}else{const w=document.querySelector(y);if(w){d=w,console.log(`找到参数信息元素: ${y}`);break}}}catch(w){console.error(`选择器 ${y} 出错:`,w)}d?(console.log("滚动到参数信息元素"),E.sendMessage("正在滚动到参数信息..."),await(async w=>{const x=w.getBoundingClientRect().top+window.pageYOffset,g=window.pageYOffset,m=x-g;if(Math.abs(m)>1e3){const f=m/5;for(let $=1;$<=5;$++){const I=g+f*$;window.scrollTo({top:I,behavior:"smooth"}),await new Promise(q=>setTimeout(q,800))}w.scrollIntoView({behavior:"smooth",block:"center"}),await new Promise($=>setTimeout($,1e3))}else w.scrollIntoView({behavior:"smooth",block:"center"}),await new Promise(p=>setTimeout(p,1500))})(d),console.log("已滚动到参数信息元素")):(console.log("未找到参数信息元素，尝试平滑滚动到页面中部"),await(async()=>{const w=document.body.scrollHeight,x=window.pageYOffset,m=w/3-x,p=8,f=m/p;for(let $=1;$<=p;$++){const I=x+f*$;window.scrollTo({top:I,behavior:"smooth"}),await new Promise(q=>setTimeout(q,400))}await new Promise($=>setTimeout($,1e3))})()),console.log('尝试点击"全部评价"按钮');const u=['div[class*="ShowButton"]','a:contains("全部评价")','button:contains("全部评价")','div:contains("全部评价")','span:contains("全部评价")'];let i=null;for(const y of u)try{if(y.includes(":contains(")){const w=y.match(/([a-z]+):/i),x=y.match(/"([^"]+)"/);if(w&&x){const g=w[1],m=x[1],p=n(g,m);if(p.length>0){i=p[0],console.log(`找到"${m}"按钮:`,i);break}}}else{const w=document.querySelector(y);if(w){i=w,console.log("找到全部评价按钮:",y);break}}}catch(w){console.error(`选择器 ${y} 出错:`,w)}if(i){console.log('点击"全部评价"按钮'),E.sendMessage('正在点击"全部评价"按钮...'),i.click(),console.log("等待评论面板加载"),await new Promise(g=>setTimeout(g,5e3)),console.log("查找leftDrawer容器");const y=document.querySelector('div[class*="leftDrawer--"]');if(y){console.log("找到leftDrawer容器");const g=y.querySelector('div[class*="comments--"][class*="beautify-scroll-bar"], div[class*="comments--"], .beautify-scroll-bar, div[class*="beautify-scroll"]');if(g){console.log("找到评论容器:",g.className),E.sendMessage("正在加载评论..."),await Ne(g,r);let m=await P(g);if(m&&m.length>r&&(console.log(`评论数量超过期望值，截取前 ${r} 条`),m=m.slice(0,r)),m&&m.length>0)return console.log(`成功从评论容器提取 ${m.length} 条评论 (总数: ${l})`),me(),E.sendMessage(`成功抓取 ${m.length}/${l} 条评论`),m;{console.log("评论容器中没有找到评论，尝试从整个leftDrawer中提取");let p=await P(y);if(p&&p.length>r&&(console.log(`评论数量超过期望值，截取前 ${r} 条`),p=p.slice(0,r)),p&&p.length>0)return console.log(`成功从leftDrawer提取 ${p.length} 条评论 (总数: ${l})`),me(),E.sendMessage(`成功抓取 ${p.length}/${l} 条评论`),p}}else{console.log("在leftDrawer中未找到评论容器，尝试从整个leftDrawer中提取评论");let m=await P(y);if(m&&m.length>r&&(console.log(`评论数量超过期望值，截取前 ${r} 条`),m=m.slice(0,r)),m&&m.length>0)return console.log(`成功从leftDrawer提取 ${m.length} 条评论 (总数: ${l})`),me(),E.sendMessage(`成功抓取 ${m.length}/${l} 条评论`),m}me()}else console.log("未找到leftDrawer容器，尝试查找其他可能的评论面板");console.log("尝试查找其他可能的评论面板");const w=['div[class*="Comments--"]','div[class*="comments--"]',"div.content--ew3Y4lVg",".tb-revbd",".rate-grid",".comment-list",".beautify-scroll-bar",".modal-content",".dialog-content",".popup-content",".overlay-content"];let x=null;for(const g of w)try{const m=document.querySelector(g);if(m){x=m,console.log("找到评论面板:",g);break}}catch(m){console.error(`选择器 ${g} 出错:`,m)}if(x){console.log("找到评论面板，加载所有评论"),E.sendMessage("正在加载评论..."),await Ne(x,r);let g=await P(x);if(g&&g.length>r&&(console.log(`评论数量超过期望值，截取前 ${r} 条`),g=g.slice(0,r)),g&&g.length>0)return console.log(`成功从评论面板提取 ${g.length} 条评论 (总数: ${l})`),E.sendMessage(`成功抓取 ${g.length}/${l} 条评论`),g}}else console.log('未找到"全部评价"按钮，尝试直接查找评论');console.log("尝试直接查找评论面板");let h=document.querySelector('div[class*="Comments--"], div.content--ew3Y4lVg, .tb-revbd, .rate-grid, .comment-list');if(h){console.log("找到评论面板，尝试加载所有评论"),await Ne(h,r);let y=await P(h);if(y&&y.length>r&&(console.log(`评论数量超过期望值，截取前 ${r} 条`),y=y.slice(0,r)),y&&y.length>0)return console.log(`成功从评论面板提取 ${y.length} 条评论 (总数: ${l})`),E.sendMessage(`成功抓取 ${y.length}/${l} 条评论`),y}console.log("尝试直接从页面中查找评论");let v=await Wt();if(v&&v.length>r&&(console.log(`评论数量超过期望值，截取前 ${r} 条`),v=v.slice(0,r)),v&&v.length>0)return console.log(`成功直接从页面提取 ${v.length} 条评论 (总数: ${l})`),E.sendMessage(`成功抓取 ${v.length}/${l} 条评论`),v;console.log("尝试使用备用方法");let b=await Ht();return b&&b.length>r&&(console.log(`评论数量超过期望值，截取前 ${r} 条`),b=b.slice(0,r)),b&&b.length>0?(console.log(`成功使用备用方法提取 ${b.length} 条评论 (总数: ${l})`),E.sendMessage(`成功抓取 ${b.length}/${l} 条评论`),b):(console.log("所有方法都失败，无法提取评论"),E.sendMessage("无法抓取评论"),[])}catch(s){return console.error("抓取评论时出错:",s),[]}}function me(){try{console.log("尝试关闭评论遮罩");const t=[".closeIcon--NdjsxNY9",'img[src*="closeIcon"]','img[src*="close"]','img[class*="closeIcon"]','div[class*="closeIcon"]','span[class*="closeIcon"]','button[class*="closeIcon"]','button[class*="close"]','div[class*="close"]','span[class*="close"]'];let e=null;for(const o of t)try{const s=document.querySelector(o);if(s){e=s,console.log("找到关闭按钮:",o);break}}catch(s){console.error(`选择器 ${o} 出错:`,s)}if(e)return console.log("点击关闭按钮"),e.click(),console.log("已关闭评论遮罩"),!0;{console.log("未找到关闭按钮");const o=document.querySelector('.leftDrawer--4H_p9fnt, div[class*="leftDrawer--"]');if(o)for(const s of t)try{const n=o.querySelector(s);if(n)return console.log("在leftDrawer中找到关闭按钮:",s),n.click(),console.log("已关闭评论遮罩"),!0}catch(n){console.error(`在leftDrawer中查找关闭按钮 ${s} 出错:`,n)}return console.log("无法关闭评论遮罩"),!1}}catch(t){return console.error("关闭评论遮罩出错:",t),!1}}async function Ne(t,e=100){if(console.log(`开始加载评论，最大数量: ${e}`),!t){console.log("评论面板不存在，无法加载评论");return}const o=e>1e3?1e3:e>100?500:e<10?50:200;console.log(`设置最大滚动尝试次数: ${o}`);let s=0,n=0;const l=15;function a(){const d=[".Comment--KkPcz74T",'div[class*="Comment--"]',".comment-item","div.contentWrapper--uAdAlCgC",".rate-item",".tb-revbd .tb-r-review",".review-item",".comment-container",".comment-list > div",".comment-list > li",'div[class*="rate-item"]','div[class*="review-item"]','div[class*="comment-item"]',"div[data-index]"];let u=[];for(const i of d)try{const h=t.querySelectorAll(i);h&&h.length>u.length&&(u=Array.from(h))}catch(h){console.error(`选择器 ${i} 查找评论元素出错:`,h)}return u}let r=0;async function c(d=0){const u=a();try{for(let b=0;b<u.length;b++){if(console.log(`开始滚动到第 ${b} 条评论`,r),b<r){console.log(`滚动到第 ${b} 条评论 已经滚动过了`,r);continue}r=b,E.scrollToElement(u[b]),await E.sleep(30),await E.waitElementInViewportUseObserver(u[b],1e3)}const i=u.length;if(console.log(`滚动尝试 #${d}: 当前评论数量 ${i}/${e}`),!(i>s)&&d>10?(n++,console.log(`连续 ${n}/${l} 次没有新评论`)):n=0,s=i,i>=e||d>=o||n>=l&&d>50)return i>=e?console.log(`已达到目标评论数量: ${i}/${e}`):d>=o?console.log(`已达到最大滚动尝试次数: ${d}/${o}`):console.log(`连续 ${n} 次没有新评论，停止滚动`),console.log(`最终评论数量: ${i}/${e}`),i;const v=Math.min(1e3,500+d*10);await E.sleep(v),await c(d+1)}catch(i){console.error("滚动出错:",i)}}await c(0)}async function P(t){console.log("开始提取评论");const e=[".Comment--KkPcz74T",'div[class*="Comment--"]',".comment-item","div.contentWrapper--uAdAlCgC",".rate-item",".tb-revbd .tb-r-review",".review-item",".comment-container",".comment-list > div",".comment-list > li",'div[class*="rate-item"]','div[class*="review-item"]','div[class*="comment-item"]',"div[data-index]"];let o=[],s="";if(t){for(const r of e)try{const c=t.querySelectorAll(r);c&&c.length>0&&(c.length>o.length?(o=Array.from(c),s=r,console.log(`在评论面板中使用选择器 ${r} 找到 ${c.length} 条评论 (当前最佳)`)):console.log(`在评论面板中使用选择器 ${r} 找到 ${c.length} 条评论`))}catch(c){console.error(`选择器 ${r} 出错:`,c)}if(console.log(`最终使用选择器 ${s} 找到 ${o.length} 条评论`),o.length===0){console.log("在评论面板中未找到评论元素，尝试查找所有子元素");const r=t.children;r&&r.length>0&&(o=Array.from(r).filter(c=>!c.className.includes("footer")&&!c.className.includes("loading")&&!c.className.includes("title")),console.log(`在评论面板中找到 ${o.length} 个可能的评论元素(直接子元素)`))}if(o.length===0){console.log("尝试查找所有可能的div元素作为评论");const r=t.querySelectorAll("div");o=Array.from(r).filter(c=>c.getBoundingClientRect().height>50&&c.textContent.length>50),console.log(`找到 ${o.length} 个可能的div评论元素`)}}else{for(const r of e)try{const c=document.querySelectorAll(r);c&&c.length>0&&(c.length>o.length?(o=Array.from(c),s=r,console.log(`在文档中使用选择器 ${r} 找到 ${c.length} 条评论 (当前最佳)`)):console.log(`在文档中使用选择器 ${r} 找到 ${c.length} 条评论`))}catch(c){console.error(`选择器 ${r} 出错:`,c)}console.log(`最终使用选择器 ${s} 找到 ${o.length} 条评论`)}if(o.length===0){console.log("尝试查找包含用户名和日期的元素");const r=t?t.querySelectorAll("div"):document.querySelectorAll("div");o=Array.from(r).filter(c=>{const d=c.textContent,u=d.includes("t**")||d.match(/[a-z]\*\*\d*/i),i=d.match(/\d{4}年\d{1,2}月\d{1,2}日/);return u&&i&&d.length>50}),console.log(`找到 ${o.length} 个可能的评论元素`)}const n=[],l=new Set;let a=-1;for(const r of o){a++;try{console.log(`处理第 ${a+1}/${o.length} 条评论`);const c=r.textContent.trim();if(l.has(c)){console.log(`跳过重复评论: ${c.substring(0,30)}...`);continue}console.log(`评论 ${a+1} 完整文本:`,c.substring(0,100)+(c.length>100?"...":""));let d="";const u=['div[class*="userName"] span',".userName--mmxkxkd0 span",'div[class*="userName--"] span',".user-name span",".username span",".name span",'div[class*="userName"]',".userName--mmxkxkd0",'div[class*="userName--"]',".user-name",".username",".name"];for(const g of u)try{const m=r.querySelector(g);if(m&&m.textContent.trim()){d=m.textContent.trim(),console.log(`从选择器 ${g} 找到用户名: ${d}`);break}}catch(m){console.error(`用户名选择器 ${g} 出错:`,m)}if(!d){const g=c.match(/[a-z]\*\*\d+/i);g&&(d=g[0],console.log(`从文本中提取用户名: ${d}`))}let i="",h="";const v=['div[class*="meta"]',".meta--TDfRej2n",'div[class*="meta--"]',".date",".spec",'div[class*="date"]','div[class*="spec"]','span[class*="date"]','span[class*="spec"]'];for(const g of v)try{const m=r.querySelector(g);if(m&&m.textContent.trim()){const p=m.textContent.trim();console.log(`从选择器 ${g} 找到meta信息: ${p}`);const f=p.split(/\s*·\s*/);if(f.length>=1){const $=f[0].match(/\d{4}年\d{1,2}月\d{1,2}日/);$&&(i=$[0],console.log(`从meta中提取日期: ${i}`))}if(f.length>=2&&(h=f.slice(1).join(" · "),console.log(`从meta中提取款式: ${h}`)),i&&h)break}}catch(m){console.error(`meta选择器 ${g} 出错:`,m)}if(!i){const g=c.match(/\d{4}年\d{1,2}月\d{1,2}日/);g&&(i=g[0],console.log(`从文本中提取日期: ${i}`))}if(!h){const g=[c.match(/规格[：:]\s*([^，。,]+)/),c.match(/颜色分类[：:]\s*([^，。,]+)/),c.match(/型号[：:]\s*([^，。,]+)/),i&&c.includes(i)&&c.substring(c.indexOf(i)+i.length).match(/[^，。,:：]+/),c.match(/左右排烟\s*\/\s*天然气\s*\/\s*([^，。,]+)/),c.match(/([【\[].+[】\]])/),c.match(/(\d+m³\/min\s*[黑白金银铜灰色]+)/)];for(const m of g)if(m&&(m[1]||m[0])&&(m[1]||m[0]).trim()){h=(m[1]||m[0]).trim(),console.log(`从文本中提取款式: ${h}`);break}}let b="";const y=[".content",".text",".comment",'div[class*="content"]','span[class*="content"]','div[class*="text"]','span[class*="text"]','div[class*="comment"]','span[class*="comment"]'];for(const g of y)try{const m=r.querySelector(g);if(m&&m.textContent.trim()){b=m.textContent.trim(),console.log(`从选择器 ${g} 找到内容: ${b.substring(0,50)}...`);break}}catch(m){console.error(`内容选择器 ${g} 出错:`,m)}b||(b=c,d&&(b=b.replace(d,"")),i&&(b=b.replace(i,"")),h&&(b=b.replace(h,"")),b=b.replace(/有用\s*\(\d+\)/g,"").replace(/回复\s*\(\d+\)/g,"").replace(/举报/g,"").replace(/此用户没有填写评价/g,"").replace(/追加评论/g,"").replace(/评价方式：/g,"").replace(/评价时间：/g,"").replace(/购买时间：/g,"").replace(/\s*·\s*/g,""),b=b.trim(),console.log(`从完整文本提取内容: ${b.substring(0,50)}...`));const w=[],x=['div[class*="cover--"][class*="photo--"] img','div[class*="--cover--"][class*="--photo--"] img'];for(const g of x){const m=r.querySelectorAll(g);for(const p of m){let f=p.getAttribute("src");f&&(f.startsWith("//")&&(f="https:"+f),w.push(f))}if(w.length>0)break}d&&b&&b!=="此用户没有填写评价"?(n.push({userName:d,purchaseDate:i,purchaseSpec:h,content:b,imgList:w,parentId:""}),l.add(c),console.log(`成功提取第 ${a+1} 条评论:`,d,i,h)):console.log("跳过无效评论:",d,b.substring(0,30)+"...")}catch(c){console.error(`提取第 ${a+1} 条评论时出错:`,c)}}return console.log(`共提取到 ${n.length} 条有效评论`),n}async function Ht(){console.log("开始从当前页面抓取评论"),E.sendMessage("正在从当前页面抓取评论...");try{console.log("尝试查找leftDrawer容器");const t=document.querySelector('.leftDrawer--4H_p9fnt, div[class*="leftDrawer--"]');if(t){console.log("找到leftDrawer容器");const c=t.querySelector('.comments--vOMSBfi2.beautify-scroll-bar, div[class*="comments--"][class*="beautify-scroll-bar"], .comments--vOMSBfi2, div[class*="comments--"], .beautify-scroll-bar, div[class*="beautify-scroll"]');if(c){console.log("找到评论容器:",c.className);const u=c.querySelectorAll('.Comment--KkPcz74T, div[class*="Comment--"]');if(u&&u.length>0){console.log(`在评论容器中找到 ${u.length} 条评论元素`);const i=await P(c);if(i&&i.length>0)return console.log(`成功从评论容器提取 ${i.length} 条评论`),i}else console.log("在评论容器中未找到评论元素，尝试从整个leftDrawer中提取")}else console.log("在leftDrawer中未找到评论容器，尝试从整个leftDrawer中提取");const d=await P(t);if(d&&d.length>0)return console.log(`成功从leftDrawer提取 ${d.length} 条评论`),d}else console.log("未找到leftDrawer容器，尝试查找其他可能的遮罩容器");console.log("尝试查找其他可能的遮罩容器");const e=[".content--ew3Y4lVg",'div[class*="content--"]',".modal-content",".dialog-content",".popup-content",".overlay-content",".beautify-scroll-bar",'div[class*="beautify-scroll"]'];let o=null;for(const c of e)try{const d=document.querySelector(c);if(d){o=d,console.log(`找到遮罩容器: ${c}`);break}}catch(d){console.error(`查找遮罩容器 ${c} 出错:`,d)}if(o){console.log("从遮罩容器中提取评论");const c=await P(o);if(c&&c.length>0)return console.log(`成功从遮罩容器中提取 ${c.length} 条评论`),c}console.log("尝试查找评论容器");const s=["div.用户评价",'div:has(> h2:contains("用户评价"))','div[class*="rate"]',"div.tb-reviews",'div[class*="comment"]','div[class*="Comment"]','div[class*="review"]','div[class*="Review"]','div[class*="评价"]','div[class*="评论"]'];let n=null;for(const c of s)try{if(c.includes(":has(")){const d=document.querySelectorAll("div");for(const u of d){const i=u.querySelector("h2");if(i&&i.textContent.includes("用户评价")){n=u,console.log('找到包含"用户评价"标题的容器');break}}}else{const d=document.querySelector(c);if(d){n=d,console.log(`找到评论容器: ${c}`);break}}}catch(d){console.error(`查找评论容器 ${c} 出错:`,d)}if(n){console.log("从评论容器中提取评论");const c=await P(n);if(c&&c.length>0)return console.log(`成功从评论容器中提取 ${c.length} 条评论`),c}console.log("尝试查找所有可能的评论元素");const l=document.querySelectorAll("div"),a=Array.from(l).filter(c=>{const d=c.textContent,u=d.includes("t**")||d.match(/[a-z]\*\*\d*/i),i=d.match(/\d{4}年\d{1,2}月\d{1,2}日/);return u&&i&&d.length>50});console.log(`找到 ${a.length} 个可能的评论元素`);const r=[];return a.forEach((c,d)=>{try{console.log(`处理第 ${d+1} 个可能的评论元素`);const u=c.textContent.trim();console.log(`评论 ${d+1} 完整文本:`,u.substring(0,100)+(u.length>100?"...":""));let i="";const h=['div[class*="userName"] span',".userName--mmxkxkd0 span",'div[class*="userName--"] span',".user-name span",".username span",".name span"];for(const p of h)try{const f=c.querySelector(p);if(f&&f.textContent.trim()){i=f.textContent.trim(),console.log(`从选择器 ${p} 找到用户名: ${i}`);break}}catch(f){console.error(`用户名选择器 ${p} 出错:`,f)}if(!i){const p=u.match(/[a-z]\*\*\d+/i);p&&(i=p[0],console.log(`从文本中提取用户名: ${i}`))}let v="",b="";const y=['div[class*="meta"]',".meta--TDfRej2n",'div[class*="meta--"]',".date",".spec"];for(const p of y)try{const f=c.querySelector(p);if(f&&f.textContent.trim()){const $=f.textContent.trim();console.log(`从选择器 ${p} 找到meta信息: ${$}`);const I=$.split(/\s*·\s*/);if(I.length>=1){const q=I[0].match(/\d{4}年\d{1,2}月\d{1,2}日/);q&&(v=q[0],console.log(`从meta中提取日期: ${v}`))}if(I.length>=2&&(b=I.slice(1).join(" · "),console.log(`从meta中提取款式: ${b}`)),v&&b)break}}catch(f){console.error(`meta选择器 ${p} 出错:`,f)}if(!v){const p=u.match(/\d{4}年\d{1,2}月\d{1,2}日/);p&&(v=p[0],console.log(`从文本中提取日期: ${v}`))}if(!b){const p=[u.match(/规格[：:]\s*([^，。,]+)/),u.match(/颜色分类[：:]\s*([^，。,]+)/),u.match(/型号[：:]\s*([^，。,]+)/),v&&u.includes(v)&&u.substring(u.indexOf(v)+v.length).match(/[^，。,:：]+/),u.match(/左右排烟\s*\/\s*天然气\s*\/\s*([^，。,]+)/),u.match(/([【\[].+[】\]])/),u.match(/(\d+m³\/min\s*[黑白金银铜灰色]+)/)];for(const f of p)if(f&&(f[1]||f[0])&&(f[1]||f[0]).trim()){b=(f[1]||f[0]).trim(),console.log(`从文本中提取款式: ${b}`);break}}let w="";const x=[".content",".text",".comment",'div[class*="content"]','span[class*="content"]','div[class*="text"]','span[class*="text"]','div[class*="comment"]','span[class*="comment"]'];for(const p of x)try{const f=c.querySelector(p);if(f&&f.textContent.trim()){w=f.textContent.trim(),console.log(`从选择器 ${p} 找到内容: ${w.substring(0,50)}...`);break}}catch(f){console.error(`内容选择器 ${p} 出错:`,f)}w||(w=u,i&&(w=w.replace(i,"")),v&&(w=w.replace(v,"")),b&&(w=w.replace(b,"")),w=w.replace(/有用\s*\(\d+\)/g,"").replace(/回复\s*\(\d+\)/g,"").replace(/举报/g,"").replace(/此用户没有填写评价/g,"").replace(/追加评论/g,"").replace(/评价方式：/g,"").replace(/评价时间：/g,"").replace(/购买时间：/g,"").replace(/\s*·\s*/g,""),w=w.trim(),console.log(`从完整文本提取内容: ${w.substring(0,50)}...`));const g=[],m=['div[class*="--cover--"][class*="--photo--"] img'];for(const p of m){const f=c.querySelectorAll(p);for(const $ of f){let I=$.getAttribute("src");I&&(I.startsWith("//")&&(I="https:"+I),g.push(I))}if(g.length>0)break}i&&w&&w!=="此用户没有填写评价"?(r.push({userName:i,purchaseDate:v,purchaseSpec:b,content:w,imgList:g,parentId:""}),console.log(`成功提取第 ${d+1} 条评论:`,i,v,b)):console.log("跳过无效评论:",i,w.substring(0,30)+"...")}catch(u){console.error(`提取第 ${d+1} 条评论时出错:`,u)}}),console.log(`共提取到 ${r.length} 条有效评论`),E.sendMessage(`成功抓取 ${r.length} 条评论`),r}catch(t){return console.error("从当前页面抓取评论出错:",t),E.sendMessage("从当前页面抓取评论出错"),[]}}async function Wt(){return console.log("开始直接查找评论"),E.sendMessage("正在直接查找评论..."),new Promise(async t=>{try{console.log("尝试查找leftDrawer容器");const e=document.querySelector('.leftDrawer--4H_p9fnt, div[class*="leftDrawer--"]');if(e){console.log("找到leftDrawer容器");const u=e.querySelector('.comments--vOMSBfi2.beautify-scroll-bar, div[class*="comments--"][class*="beautify-scroll-bar"], .comments--vOMSBfi2, div[class*="comments--"], .beautify-scroll-bar, div[class*="beautify-scroll"]');if(u){console.log("找到评论容器:",u.className);const h=u.querySelectorAll('.Comment--KkPcz74T, div[class*="Comment--"]');if(h&&h.length>0){console.log(`在评论容器中找到 ${h.length} 条评论元素`);const v=await P(u);if(v&&v.length>0){console.log(`成功从评论容器提取 ${v.length} 条评论`),E.sendMessage(`成功抓取 ${v.length} 条评论`),t(v);return}}else console.log("在评论容器中未找到评论元素，尝试从整个leftDrawer中提取")}else console.log("在leftDrawer中未找到评论容器，尝试从整个leftDrawer中提取");const i=await P(e);if(i&&i.length>0){console.log(`成功从leftDrawer提取 ${i.length} 条评论`),E.sendMessage(`成功抓取 ${i.length} 条评论`),t(i);return}}else console.log("未找到leftDrawer容器，尝试查找其他可能的遮罩容器");console.log("尝试查找其他可能的遮罩容器");const o=[".content--ew3Y4lVg",'div[class*="content--"]',".modal-content",".dialog-content",".popup-content",".overlay-content",".beautify-scroll-bar",'div[class*="beautify-scroll"]'];let s=null;for(const u of o)try{const i=document.querySelector(u);if(i){s=i,console.log(`找到遮罩容器: ${u}`);break}}catch(i){console.error(`查找遮罩容器 ${u} 出错:`,i)}if(s){console.log("从遮罩容器中提取评论");const u=await P(s);if(u&&u.length>0){console.log(`成功从遮罩容器中提取 ${u.length} 条评论`),E.sendMessage(`成功抓取 ${u.length} 条评论`),t(u);return}}console.log("从整个页面查找评论");const n=["div.用户评价",'div:has(> h2:contains("用户评价"))','div[class*="rate"]',"div.tb-reviews",'div[class*="comment"]','div[class*="Comment"]','div[class*="review"]','div[class*="Review"]','div[class*="评价"]','div[class*="评论"]'];let l=[];for(const u of n)try{if(u.includes(":has(")){const i=document.querySelectorAll("div");for(const h of i){const v=h.querySelector("h2");if(v&&v.textContent.includes("用户评价")){console.log('找到包含"用户评价"标题的容器');const b=await P(h);b&&b.length>0&&(console.log(`从包含"用户评价"标题的容器中提取到 ${b.length} 条评论`),l=l.concat(b))}}}else{const i=document.querySelectorAll(u);if(i&&i.length>0){console.log(`找到 ${i.length} 个评论容器: ${u}`);for(const h of i){const v=await P(h);v&&v.length>0&&(console.log(`从容器 ${u} 中提取到 ${v.length} 条评论`),l=l.concat(v))}}}}catch(i){console.error(`查找评论容器 ${u} 出错:`,i)}if(l.length>0){const u=[],i=new Set;for(const h of l){const v=`${h.userName}-${h.content.substring(0,50)}`;i.has(v)||(i.add(v),u.push(h))}if(console.log(`从所有容器中共提取到 ${l.length} 条评论，去重后剩余 ${u.length} 条`),u.length>0){E.sendMessage(`成功抓取 ${u.length} 条评论`),t(u);return}}console.log("尝试查找所有可能的评论元素");const a=document.querySelectorAll("div"),r=Array.from(a).filter(u=>{const i=u.textContent,h=i.includes("t**")||i.match(/[a-z]\*\*\d*/i),v=i.match(/\d{4}年\d{1,2}月\d{1,2}日/);return h&&v&&i.length>50});console.log(`找到 ${r.length} 个可能的评论元素`);const c=[],d=new Set;r.forEach((u,i)=>{try{console.log(`处理第 ${i+1}/${r.length} 个可能的评论元素`);const h=u.textContent.trim();if(d.has(h)){console.log(`跳过重复评论: ${h.substring(0,30)}...`);return}console.log(`评论 ${i+1} 完整文本:`,h.substring(0,100)+(h.length>100?"...":""));let v="";const b=['div[class*="userName"] span',".userName--mmxkxkd0 span",'div[class*="userName--"] span',".user-name span",".username span",".name span",'div[class*="userName"]',".userName--mmxkxkd0",'div[class*="userName--"]',".user-name",".username",".name"];for(const p of b)try{const f=u.querySelector(p);if(f&&f.textContent.trim()){v=f.textContent.trim(),console.log(`从选择器 ${p} 找到用户名: ${v}`);break}}catch(f){console.error(`用户名选择器 ${p} 出错:`,f)}if(!v){const p=h.match(/[a-z]\*\*\d+/i);p&&(v=p[0],console.log(`从文本中提取用户名: ${v}`))}let y="",w="";const x=['div[class*="meta"]',".meta--TDfRej2n",'div[class*="meta--"]',".date",".spec",'div[class*="date"]','div[class*="spec"]','span[class*="date"]','span[class*="spec"]'];for(const p of x)try{const f=u.querySelector(p);if(f&&f.textContent.trim()){const $=f.textContent.trim();console.log(`从选择器 ${p} 找到meta信息: ${$}`);const I=$.split(/\s*·\s*/);if(I.length>=1){const q=I[0].match(/\d{4}年\d{1,2}月\d{1,2}日/);q&&(y=q[0],console.log(`从meta中提取日期: ${y}`))}if(I.length>=2&&(w=I.slice(1).join(" · "),console.log(`从meta中提取款式: ${w}`)),y&&w)break}}catch(f){console.error(`meta选择器 ${p} 出错:`,f)}if(!y){const p=h.match(/\d{4}年\d{1,2}月\d{1,2}日/);p&&(y=p[0],console.log(`从文本中提取日期: ${y}`))}if(!w){const p=[h.match(/规格[：:]\s*([^，。,]+)/),h.match(/颜色分类[：:]\s*([^，。,]+)/),h.match(/型号[：:]\s*([^，。,]+)/),y&&h.includes(y)&&h.substring(h.indexOf(y)+y.length).match(/[^，。,:：]+/),h.match(/左右排烟\s*\/\s*天然气\s*\/\s*([^，。,]+)/),h.match(/([【\[].+[】\]])/),h.match(/(\d+m³\/min\s*[黑白金银铜灰色]+)/)];for(const f of p)if(f&&(f[1]||f[0])&&(f[1]||f[0]).trim()){w=(f[1]||f[0]).trim(),console.log(`从文本中提取款式: ${w}`);break}}let g="";const m=[".content",".text",".comment",'div[class*="content"]','span[class*="content"]','div[class*="text"]','span[class*="text"]','div[class*="comment"]','span[class*="comment"]'];for(const p of m)try{const f=u.querySelector(p);if(f&&f.textContent.trim()){g=f.textContent.trim(),console.log(`从选择器 ${p} 找到内容: ${g.substring(0,50)}...`);break}}catch(f){console.error(`内容选择器 ${p} 出错:`,f)}g||(g=h,v&&(g=g.replace(v,"")),y&&(g=g.replace(y,"")),w&&(g=g.replace(w,"")),g=g.replace(/有用\s*\(\d+\)/g,"").replace(/回复\s*\(\d+\)/g,"").replace(/举报/g,"").replace(/此用户没有填写评价/g,"").replace(/追加评论/g,"").replace(/评价方式：/g,"").replace(/评价时间：/g,"").replace(/购买时间：/g,"").replace(/\s*·\s*/g,""),g=g.trim(),console.log(`从完整文本提取内容: ${g.substring(0,50)}...`)),v&&g&&g!=="此用户没有填写评价"?(c.push({userName:v,purchaseDate:y,purchaseSpec:w,content:g,parentId:"",imgList:[]}),d.add(h),console.log(`成功提取第 ${i+1} 条评论:`,v,y,w)):console.log("跳过无效评论:",v,g.substring(0,30)+"...")}catch(h){console.error(`提取第 ${i+1} 条评论时出错:`,h)}}),console.log(`共提取到 ${c.length} 条有效评论`),E.sendMessage(`成功抓取 ${c.length} 条评论`),t(c)}catch(e){console.error("直接查找评论出错:",e),E.sendMessage("直接查找评论出错"),t([])}})}async function Ft(){console.log("准备抓取淘宝商品详情数据");const t=window.scrollY<50,e=window.location.href.includes("detail.tmall.com")||window.location.href.includes("tmall.com/item");t?console.log("页面已在顶部，无需滚动"):(console.log("页面不在顶部，开始滚动加载..."),await Bt(),e||(console.log("淘宝详情页需要回到顶部才能抓取完整数据"),window.scrollTo(0,0),await new Promise(T=>setTimeout(T,1e3)))),console.log("开始抓取详情页主数据");let o=[];try{o=await ut()}catch(T){console.error("抓取款式选项时出错:",T)}const s=document.querySelector('.mainTitle--ocKo1xwj, [class*="mainTitle--"], .tb-detail-hd h1, .tb-main-title, .ItemHeader--title'),n=s?s.innerText.trim():"";let l="",a="";const r=[".J_price",".tm-price",".J_priceStd","#J_StrPrice",".tb-rmb-num",".mod-info-price .price",".tb-detail-price .tb-rmb-num",'[class*="Price--small--"]','[class*="Price--large--"]','[class*="Price--normal--"]','[class*="Price--priceText--"]','[class*="Price--priceInteger--"]','[class*="Price--priceDecimal--"]','[class*="highlightPrice--"] [class*="text--"]'];for(const T of r){const S=document.querySelector(T);if(S&&S.innerText.trim()){l=S.innerText.trim();break}}const c=[".J_priceOri",".J_originalPrice",".mod-info-price .price-original",".tb-detail-price .tb-rmb-num.tb-rmb-del",".tm-price-panel .tm-price-panel-price-original",'[class*="Price--delete--"]','[class*="Price--deleted--"]','[class*="Price--original--"]','[class*="subPrice--"] [class*="text--"]:last-child'];for(const T of c){const S=document.querySelector(T);if(S&&S.innerText.trim()){a=S.innerText.trim();break}}if(!l){const T=/¥\s*(\d+(\.\d+)?)/,O=document.body.innerText.match(T);O&&O[1]&&(l=O[1])}const d=document.querySelector('[class*="salesDesc--"]');let u="";if(d){const T=d.innerText.trim(),S=T.match(/已售\s*([\d万千百十亿]+\+?)/);S&&S[1]?u=S[1]:u=T.replace("·","").trim()}if(!u){const T=document.querySelector('[class*="summaryWrap--"] [class*="salesDesc--"]');if(T){const S=T.innerText.trim(),O=S.match(/已售\s*([\d万千百十亿]+\+?)/);O&&O[1]?u=O[1]:u=S.replace("已售","").trim()}}const i=[],h=document.querySelectorAll('[class*="couponText--"]'),v=new Set;h.forEach(T=>{if(T&&T.innerText){const S=T.innerText.trim();v.has(S)||(v.add(S),i.push(S))}});const b=[];document.querySelectorAll('[class*="thumbnailPic--"], .tb-thumb li img, .tm-layout-list-item img').forEach(T=>{if(T&&T.src){let S=T.src;S=S.replace(/_\d+x\d+q\d+\.jpg/g,""),S=S.replace(/_\d+x\d+\.jpg/g,""),S=S.replace(/\.jpg_\d+x\d+q\d+\.jpg/g,".jpg"),S=S.replace(/\.jpg_\d+x\d+\.jpg/g,".jpg"),(S.includes("_60x60q90")||S.includes("_50x50.jpg"))&&(S=S.replace("_60x60q90","").replace("_50x50.jpg","")),b.push(S)}});let w="";const x=['[class*="mainPic--"]',".tb-booth img",".tb-main-pic img",".magnifier-preview img",".preview-img img"];for(const T of x){const S=document.querySelector(T);if(S&&S.src){w=S.src;break}}!w&&b.length>0&&(w=b[0]),!w&&b.length>0&&(w=b[0]);let g="";const m=["video source",".lib-video video source",".tb-video-player video source",".mui-player video source",'[data-role="videoPlayer"] video source'];for(const T of m){const S=document.querySelector(T);if(S&&S.src){g=S.src;break}}if(!g){const T=document.querySelector("video");T&&T.src&&(g=T.src)}let p="";const f=document.querySelector('[class*="shipping--"]');f&&(p=f.innerText.trim());let $="";const I=document.querySelector('[class*="freight--"]');I&&($=I.innerText.trim());let q="";const K=document.querySelector('[class*="delivery-from-addr--"]');K&&(q=K.innerText.trim());let oe="";const ge=document.querySelector('[class*="guaranteeText--"]');ge&&(oe=ge.innerText.trim());const ne=[],pe=[],Jt=['[class*="skuItem--"]','[class*="tabDetailItem--"] [class*="infoItem--"]',".tb-attributes .attributes-list li",".tm-fcs-panel .tm-fcs-properties .tm-fcs-property",".attributes-list .property-item"];for(const T of Jt){const S=document.querySelectorAll(T);if(S&&S.length>0&&(S.forEach(O=>{const se=['[class*="ItemLabel--"]','[class*="infoItemTitle--"]',".property-name",".tb-property-type",".tm-fcs-prop-key"],ve=['[class*="skuValueWrap--"] [class*="valueItem--"] ','[class*="infoItemContent--"]',".property-value",".tb-property-cont",".tm-fcs-prop-value"];let H=null;for(const N of se)if(H=O.querySelector(N),H)break;let D=null;for(const N of ve)if(D=O.querySelector(N),D)break;if(H&&D){const N=H.innerText.trim(),k=D.innerText.trim();ne.push(N),pe.push(k)}}),ne.length>0))break}let we="",be=[];const Qt=['[class*="imageTextInfo--"]',".descV8-container",".desc-root","#J_DivItemDesc","#description",".tb-desc",".detail-content",".detail-desc",".detail-desc-decorate"];for(const T of Qt){const S=document.querySelector(T);if(S){const O=Array.from(S.querySelectorAll("p, h1, h2, h3, h4, h5, h6, span, div")).filter(D=>D.textContent&&!D.querySelector("a")&&D.className!=="descV8-hotArea").map(D=>D.textContent.trim()).filter(D=>D.length>0),se=[],ve=new Set;O.forEach(D=>{if(D.length<10){se.push(D);return}let N=!1;for(const k of ve)if(k===D||k.includes(D)||D.includes(k)){N=!0;break}N||(ve.add(D),se.push(D))}),we=se.join(`
`);const H=S.querySelectorAll(".descV8-singleImage img, .descV8-singleImage-image");if(H&&H.length>0){const D=new Set;H.forEach(N=>{const k=N.getAttribute("data-src")||N.src;if(k&&!k.includes("g.alicdn.com/s.gif")){let W=k;k.startsWith("//")&&(W="https:"+k),D.add(W)}}),be=Array.from(D)}else{const D=S.querySelectorAll("img"),N=new Set;D.forEach(k=>{const W=k.getAttribute("data-src")||k.src;if(W&&!W.includes("g.alicdn.com/s.gif")){let ot=W;W.startsWith("//")&&(ot="https:"+W),N.add(ot)}}),be=Array.from(N)}if(we&&we.length>500||be.length>10)break}}console.log("开始抓取评论数据...");const Ve=await jt(),Le=window.location.href.match(/([&|?]id=(\d+)&)|([&|?]id=(\d+)$)/),tt=Le?Le[2]||Le[4]||E.simpleUUID():"";Ve&&Ve.forEach(T=>{T.parentId=tt});const Gt={id:tt,title:n,price:{discount:l,original:a},sales:u,coupons:i,images:b,mainImage:w,videoUrl:g,shipping:{info:p,freight:$,fromAddr:q},guarantee:oe,sku:{skuKeys:ne,skuValues:pe},detail:{content:we,images:be},skuOptions:o,comments:Ve};return console.log("详情数据抓取完成"),Gt}async function Bt(){return console.log("开始滚动加载淘宝/天猫详情页面"),E.sendMessage("正在加载商品详情，请稍候..."),new Promise(async t=>{try{let e=function(a,r){const c=document.getElementsByTagName(a);return Array.from(c).filter(d=>d.textContent.includes(r))};const o=Math.max(document.body.scrollHeight,document.documentElement.scrollHeight),s=window.innerHeight;window.scrollTo({top:o*.25,behavior:"smooth"}),console.log(`滚动到页面的25%位置: ${o*.25}/${o}`),await new Promise(a=>setTimeout(a,1500)),window.scrollTo({top:o*.5,behavior:"smooth"}),console.log(`滚动到页面的50%位置: ${o*.5}/${o}`),await new Promise(a=>setTimeout(a,1500)),window.scrollTo({top:o*.75,behavior:"smooth"}),console.log(`滚动到页面的75%位置: ${o*.75}/${o}`),await new Promise(a=>setTimeout(a,1500)),window.scrollTo({top:o,behavior:"smooth"}),console.log(`滚动到页面底部: ${o}/${o}`),await new Promise(a=>setTimeout(a,2e3)),console.log('尝试点击各种"查看更多"、"展开"按钮');const n=['a:contains("查看更多")','button:contains("查看更多")','a:contains("展开")','button:contains("展开")','a:contains("更多")','button:contains("更多")','[data-spm-click*="展开"]','[class*="expand"]','[class*="more"]','[class*="ShowMore"]','[class*="ShowButton"]'];for(const a of n)try{if(a.includes(":contains(")){const r=a.match(/([a-z]+):contains\("(.+)"\)/);if(r){const c=r[1],d=r[2],u=e(c,d);console.log(`找到 ${u.length} 个包含文本"${d}"的 ${c} 元素`);for(const i of u)i.offsetParent!==null&&(console.log(`点击按钮: "${i.textContent}"`),i.click(),await new Promise(h=>setTimeout(h,1e3)))}}else{const r=document.querySelectorAll(a);console.log(`找到 ${r.length} 个匹配选择器 "${a}" 的元素`);for(const c of r)c.offsetParent!==null&&(console.log(`点击按钮: "${c.textContent||a}"`),c.click(),await new Promise(d=>setTimeout(d,1e3)))}}catch(r){console.error(`选择器 ${a} 出错:`,r)}console.log("再次滚动页面以确保所有内容都加载出来"),window.scrollTo({top:o*.25,behavior:"smooth"}),await new Promise(a=>setTimeout(a,1e3)),window.scrollTo({top:o*.5,behavior:"smooth"}),await new Promise(a=>setTimeout(a,1e3)),window.scrollTo({top:o*.75,behavior:"smooth"}),await new Promise(a=>setTimeout(a,1e3)),window.scrollTo({top:o,behavior:"smooth"}),await new Promise(a=>setTimeout(a,3e3));const l=e("a","查看更多评价").concat(e("button","查看更多评价"),e("div","查看更多评价"),e("span","全部评价"));if(l.length>0){console.log(`找到 ${l.length} 个"查看更多评价"按钮`);for(const a of l)a.offsetParent!==null&&(console.log(`点击"${a.textContent}"按钮`),a.click(),await new Promise(r=>setTimeout(r,2e3)))}window.scrollTo({top:0,behavior:"smooth"}),console.log("滚动加载完成，已回到页面顶部"),await new Promise(a=>setTimeout(a,1e3)),E.sendMessage("页面加载完成，开始抓取数据..."),t(!0)}catch(e){console.error("滚动过程中出错:",e),t(!1)}})}const Kt={matches:["*://s.taobao.com/search*","*://item.taobao.com/item*","*://detail.tmall.com/item*","*://detail.tmall.hk/*"],main:t=>{console.log("Hello taobao content."),rt(Ut)}};async function Ut(t,e){(t===Y.taobao.domain||t===Y.tmall.domain)&&document.querySelector(".baxia-dialog")&&document.querySelector(".baxia-dialog").remove();let o,s="unsupported";console.log("当前域名:",t),console.log("当前URL:",e),e.includes("/search")?(console.log("检测到淘宝/天猫搜索页面，开始抓取商品搜索数据"),o=await at(),s="search"):e.includes("item.taobao.com")||e.includes("detail.tmall.com")||e.includes("detail.tmall.hk")?(console.log("检测到淘宝/天猫详情页面，开始抓取商品详情数据"),o=await Ft(),s="detail"):console.log("不是支持的淘宝/天猫页面类型，抓取跳过");const n=new Date().toLocaleString(),l={domain:t,type:s,data:o,fetchTime:n};return console.log("抓取结果:",l),l}function de(t,...e){}const Yt={debug:(...t)=>de(console.debug,...t),log:(...t)=>de(console.log,...t),warn:(...t)=>de(console.warn,...t),error:(...t)=>de(console.error,...t)},he=class he extends Event{constructor(e,o){super(he.EVENT_NAME,{}),this.newUrl=e,this.oldUrl=o}};C(he,"EVENT_NAME",Re("wxt:locationchange"));let ke=he;function Re(t){var e;return`${(e=M==null?void 0:M.runtime)==null?void 0:e.id}:taobao:${t}`}function zt(t){let e,o;return{run(){e==null&&(o=new URL(location.href),e=t.setInterval(()=>{let s=new URL(location.href);s.href!==o.href&&(window.dispatchEvent(new ke(s,o)),o=s)},1e3))}}}const te=class te{constructor(e,o){C(this,"isTopFrame",window.self===window.top);C(this,"abortController");C(this,"locationWatcher",zt(this));C(this,"receivedMessageIds",new Set);this.contentScriptName=e,this.options=o,this.abortController=new AbortController,this.isTopFrame?(this.listenForNewerScripts({ignoreFirstEvent:!0}),this.stopOldScripts()):this.listenForNewerScripts()}get signal(){return this.abortController.signal}abort(e){return this.abortController.abort(e)}get isInvalid(){return M.runtime.id==null&&this.notifyInvalidated(),this.signal.aborted}get isValid(){return!this.isInvalid}onInvalidated(e){return this.signal.addEventListener("abort",e),()=>this.signal.removeEventListener("abort",e)}block(){return new Promise(()=>{})}setInterval(e,o){const s=setInterval(()=>{this.isValid&&e()},o);return this.onInvalidated(()=>clearInterval(s)),s}setTimeout(e,o){const s=setTimeout(()=>{this.isValid&&e()},o);return this.onInvalidated(()=>clearTimeout(s)),s}requestAnimationFrame(e){const o=requestAnimationFrame((...s)=>{this.isValid&&e(...s)});return this.onInvalidated(()=>cancelAnimationFrame(o)),o}requestIdleCallback(e,o){const s=requestIdleCallback((...n)=>{this.signal.aborted||e(...n)},o);return this.onInvalidated(()=>cancelIdleCallback(s)),s}addEventListener(e,o,s,n){var l;o==="wxt:locationchange"&&this.isValid&&this.locationWatcher.run(),(l=e.addEventListener)==null||l.call(e,o.startsWith("wxt:")?Re(o):o,s,{...n,signal:this.signal})}notifyInvalidated(){this.abort("Content script context invalidated"),Yt.debug(`Content script "${this.contentScriptName}" context invalidated`)}stopOldScripts(){window.postMessage({type:te.SCRIPT_STARTED_MESSAGE_TYPE,contentScriptName:this.contentScriptName,messageId:Math.random().toString(36).slice(2)},"*")}verifyScriptStartedEvent(e){var l,a,r;const o=((l=e.data)==null?void 0:l.type)===te.SCRIPT_STARTED_MESSAGE_TYPE,s=((a=e.data)==null?void 0:a.contentScriptName)===this.contentScriptName,n=!this.receivedMessageIds.has((r=e.data)==null?void 0:r.messageId);return o&&s&&n}listenForNewerScripts(e){let o=!0;const s=n=>{if(this.verifyScriptStartedEvent(n)){this.receivedMessageIds.add(n.data.messageId);const l=o;if(o=!1,l&&(e!=null&&e.ignoreFirstEvent))return;this.notifyInvalidated()}};addEventListener("message",s),this.onInvalidated(()=>removeEventListener("message",s))}};C(te,"SCRIPT_STARTED_MESSAGE_TYPE",Re("wxt:content-script-started"));let Oe=te;function to(){}function fe(t,...e){}const Xt={debug:(...t)=>fe(console.debug,...t),log:(...t)=>fe(console.log,...t),warn:(...t)=>fe(console.warn,...t),error:(...t)=>fe(console.error,...t)};return(async()=>{try{const{main:t,...e}=Kt,o=new Oe("taobao",e);return await t(o)}catch(t){throw Xt.error('The content script "taobao" crashed on startup!',t),t}})()}();
taobao;
